#!/bin/bash

# NAVIGATE TO FOLDER IN WORKSPACE

# --- CONFIGURATION ---
REPO_URL="https://github.com/bwaxse/waxse-aou-toolkit"
# Test SOURCE_PATTERN
SOURCE_PATTERN="../B.05a\ Construct\ and\ Calculate\ PheRSs\ v1\ \(variable\ HR\ threshold\).ipynb"       # Where are the files coming from?
DEST_FOLDER="lc_wearables"   # Where do they go in the repo?

# 1. SETUP & INITIALIZE
# ---------------------
echo "Initializing Ghost Repo..."
rm -rf github-link                 # Safety clean of old runs
git clone --depth 1 "$REPO_URL" github-link
cd github-link
git config user.email "bennettwaxse@gmail.com"
git config user.name "Bennett Waxse"

# 2. PREPARE DIRECTORY
# --------------------
echo "Creating destination folder: $DEST_FOLDER"
mkdir -p "$DEST_FOLDER/notebooks"

# Copy notebooks to /notebooks subfolder
cp $SOURCE_PATTERN "./$DEST_FOLDER/notebooks/"

# 3. SAFETY SCRUBBING (CRITICAL)
# ------------------------------
echo "Scrubbing sensitive bucket paths..."
sed -i 's|gs://fc-secure-[a-zA-Z0-9_-]*|{bucket or my_bucket}|g' "$DEST_FOLDER"/notebooks/*.ipynb

echo "Scanning for other secrets (Tokens, Keys)..."
grep -Ei "api_key|token|secret|password|auth" "$DEST_FOLDER"/notebooks/*.ipynb || true

# 4. OUTPUT STRIPPING & CONVERSION
# --------------------------------
echo "Stripping all notebook outputs (Data Privacy)..."
jupyter nbconvert --clear-output --inplace "$DEST_FOLDER"/notebooks/*.ipynb

echo "Generating .py files for Claude/Gemini..."
# Convert and output .py files to $DEST_FOLDER root
jupyter nbconvert --to python --output-dir="$DEST_FOLDER" "$DEST_FOLDER"/notebooks/*.ipynb

# 5. CLEANUP
# ----------
# Create a local .gitignore so we don't upload pycache junk
echo "__pycache__/" > "$DEST_FOLDER/.gitignore"
echo ".ipynb_checkpoints/" >> "$DEST_FOLDER/.gitignore"

# 6. PUSH TO GITHUB
# -----------------
echo "â¬†Syncing with GitHub..."
git add "$DEST_FOLDER"
git commit -m "Upload: Cleaned notebooks + Python exports for AI"
git push origin main
echo "Done! Your clean code is now on GitHub."